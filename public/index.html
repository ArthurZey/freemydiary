<!doctype html>
<html>
  <head>
    <title>FreeMyDiary.com</title>
  </head>
  <body>
    <header>
      <h1>FreeMyDiary.com</h1>
    </header>

    <main>
      <h2>Export your MyFitnessPal food diary to Excel and JSON
in 3 easy steps:</h2>
      <div class="steps">
        <div class="step">
          <p>1. Verify your MyFitnessPal Diary is Public:</p>
          <form id="mfp-username">
            <input id="username" type="text" required placeholder="enter your username"></input>
            <button type="submit">Check</button>
          </form>
        </div>

        <form id="mfp-fetch">
          <div class="step">
            <p>2. Select Date Range:</p>
            <input id="startDate" type="text" required placeholder="YYYY-MM-DD" pattern="(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))" title="Please enter valid date in YYYY-MM-DD format"></input>
            <span>to</span>
            <input id="endDate" type="text" required placeholder="YYYY-MM-DD" pattern="(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))" title="Please enter valid date in YYYY-MM-DD format"></input>
          </div>

          <div class="step">
            <p>3. Download your Data:</p>
            <button type="submit">Download Excel (.xls)</button>
            <a href="" id="csvLink" download="mfp-data.csv"></a>
            <!-- <button type="submit">Download JSON</button> -->
          </div>
        </form>

      </div>

      <button class="test">AJAX Test</button>
    </main>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script>
    $(document).ready(function() {
      var convertToCSV = function(arrayOfDateObjects){
        var csv = "date";
        var nutrients = [];

        //define available nutrient fields and create header line in csv
        for (var nutrient in arrayOfDateObjects[0]) {
          if (nutrient !== 'date') {
            nutrients.push(nutrient);
            csv += "," + nutrient;
          }
        }
        console.log(csv);

        //add nutrient data into csv string
        for(var i=0; i < arrayOfDateObjects.length; i++) {
          var dateObject = arrayOfDateObjects[i];

          csv += "\n" + dateObject.date;

          for (var j=0; j < nutrients.length; j++) {
            csv += "," + dateObject[nutrients[j]];
          }
    		}
        console.log(csv);
        return csv;
      };

      var $username;
      var $startDate;
      var $endDate;

      //Diary Check
      $('#mfp-username').submit(function(event) {
        $username = $('#username').val();

        if ($username !== '') {
          $.get( "api/userCheck", {"username": $username }, function( data ) {
            console.log(data);
          });
        }
        event.preventDefault();
      });

      //Fetch Data
      $('#mfp-fetch').submit(function(event) {
        $startDate = $('#startDate').val();
        $endDate = $('#endDate').val();
        var fetchParams = {
          "username": $username,
          "startDate": $startDate,
          "endDate": $endDate
        };

        $.get( "api/fetchData", fetchParams, function( results ){
          var csv = convertToCSV(results.data);
          convertToCSV(results.data);
          $("#csvLink").attr("href", 'data:Application/octet-stream,' + encodeURIComponent(csv))[0].click();
          $("#username").val('');
          $("#startDate").val('');
          $("#endDate").val('');
        });
        event.preventDefault();
      });

      $(".test").on("click", function(event){
        $.get( "api/fetchData", {username: "azey47", startDate: "2014-10-07", endDate: "2014-10-10"}, function( results ){
          var csv = convertToCSV(results.data);
          $("#csvLink").attr("href", 'data:Application/octet-stream,' + encodeURIComponent(csv))[0].click();
          $("#username").val('');
          $("#startDate").val('');
          $("#endDate").val('');
        });
        event.preventDefault();
      });

    });
  </script>
  </body>
</html>
